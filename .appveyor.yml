version: 3.1.6-{build}

image:
  - Visual Studio 2013
  - Visual Studio 2017
clone_depth: 1


before_build:
  - ps: >-
      if($env:APPVEYOR_BUILD_WORKER_IMAGE -Match "Visual Studio 2013") {
        cd C:\projects\libmodbus\src\win32
        cscript.exe configure.js
        curl https://raw.githubusercontent.com/chemeris/msinttypes/master/stdint.h -o ..\stdint.h
      } else {
        cd C:\projects\libmodbus
        if($env:PLATFORM -Match "cygwin") {
          $env:CYGWIN_ROOT="C:\cygwin"
        } else {
          $env:CYGWIN_ROOT="C:\cygwin"
        }
        $env:PATH="$env:CYGWIN_ROOT\bin;$env:PATH"
      }

platform:
  - Win32
  - x64
  - cygwin
  - cygwin64

matrix:
  exclude:
    - image: Visual Studio 2013
      platform: cygwin
    - image: Visual Studio 2013
      platform: cygwin64
    - image: Visual Studio 2017
      platform: Win32
    - image: Visual Studio 2017
      platform: x64

configuration: Release

build_script:
  - ps: >-
      if($env:APPVEYOR_BUILD_WORKER_IMAGE -Match "Visual Studio 2013") {
        cd C:\projects\libmodbus\src\win32
        C:\WINDOWS\Microsoft.NET\Framework\v3.5\msbuild.exe "$env:APPVEYOR_BUILD_FOLDER\src\win32\modbus.vcproj" "/p:Configuration=$env:CONFIGURATION" "/p:Platform=$env:PLATFORM"
      } else {
        cd C:\projects\libmodbus
        bash autogen.sh
        bash configure
        bash -c 'make'
      }

test_script:
  # cygwin
  - cmd: cd C:\projects\libmodbus
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - cmd: bash -c 'make check; cat tests/test-suite.log'

after_build:
  - ps: >-
      if($env:APPVEYOR_BUILD_WORKER_IMAGE -Match "Visual Studio 2013") {
        cd C:\projects\libmodbus\src\win32
        7z `
        a `
        ..\..\modbus.zip `
        ..\stdint.h `
        ..\modbus.h `
        ..\modbus-version.h `
        ..\modbus-tcp.h `
        ..\modbus-rtu.h `
        ".\$env:PLATFORM\$env:CONFIGURATION\modbus.dll" `
        ".\$env:PLATFORM\$env:CONFIGURATION\modbus.exp" `
        ".\$env:PLATFORM\$env:CONFIGURATION\modbus.lib" `
        ".\$env:PLATFORM\$env:CONFIGURATION\modbus.pdb"
      } else {
        cd C:\projects\libmodbus
        7z `
        a `
        modbus.zip `
        modbus.h `
        modbus-version.h `
        modbus-tcp.h `
        modbus-rtu.h `
        .\.libs\cygmodbus-5.dll `
        .\.libs\libmodbus.dll.a `
        .\.libs\libmodbus.lai `
      }

artifacts:
  - path: modbus.zip
